#!/bin/bash

BASH_NO=no . /etc/profile

DIR="/Applications/MailMate.app/Contents/SharedSupport/bin"

if [ ! -f "${DIR}/sundown-orig" ]; then
  cp "${DIR}/sundown" "${DIR}/sundown-orig"
fi

if [ ! -f "${DIR}/sundown-github" ]; then
  touch "${DIR}/sundown-github"
  cat <<EOT >> "${DIR}/sundown-github"
#!/bin/bash

BASH_NO=no . /etc/profile

TMPFILE=\$(mktemp -t sundown_data) || exit 1
cat | perl -pe 's,</?o:[^>]*>,,g' >\${TMPFILE}

cat \${TMPFILE} | curl -X POST -H "Content-Type: text/plain" --data-binary @- "https://api.github.com/markdown/raw?access_token=\$GITHUB_TOKEN"
EOT
  chmod +x "${DIR}/sundown-github"
fi

cp "${DIR}/sundown-github" "${DIR}/sundown"
